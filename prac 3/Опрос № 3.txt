Опрос № 3. 
Темы: автономные системы Интернета, протокол BGP.


1. Дать определение Автономной системы (АС) согласно RFC 1930. Как менялось это определение с течением времени? Чем обусловлено такое изменение? Привести классификацию АС согласно RFC 1772 и описать каждый тип.
AS представляет собой группу из одного или нескольких префиксов IP, работающих у одного или нескольких сетевых
операторов, которые имеют единую (SINGLE) и четко определенную (CLEARLY DEFINED) политику маршрутизации


По классическому определению автономная система представляет собой множество маршрутизаторов с единым техническим
администрированием, использующих один протокол внутренней маршрутизации (IGP) и единую метрику для маршрутизации
пакетов внутри AS, а для передачи пакетов в другие автономные системы применяющих протокол внешней маршрутизации
(exterior gateway protocol или EGP). Со временем классическое определение было расширено и в современном понимании AS
может использовать несколько протоколов внутренней маршрутизации, а в некоторых случаях даже несколько наборов
метрик в рамках одной AS. Использование термина AS в таких случаях обусловлено тем, что даже при использовании
множества метрик и протоколов IGP администрирование такой AS с точки зрения других автономных систем выглядит как
единый план внутренней маршрутизации и показывает согласованную картину доступности адресатов с использованием
данной AS.
8 Классификация AS согласно RFC1772
Тупиковая(stub) AS –автономная система, имеющая соединение только с одной AS.
Многодомная(multihomed) AS –автономная система, соединенная с несколькими AS, но не принимающая транзитный трафик.
Транзитная AS –автономная система, соединенная с множеством других AS и предназначенная (с некоторыми ограничениями на уровне политики) для поддержки как локального, так и транзитного трафика.


2. Как в протоколе BGP-4 реализована борьба с маршрутными петлями?


Если атрибут AS_PATH маршрута BGP содержит петлю (AS loop), маршрут BGP следует исключить из рассмотрения в
фазе 2. Детектирование петель осуществляется путем полного сканирования пути, указанного в атрибуте AS_PATH, и проверки отсутствия в нем номера локальной AS. Обсуждение работы узлов BGP, настроенных на восприятие
маршрутов с номером AS этого узла в атрибутах пути, выходит за пределы данного документа.
Важно, чтобы узлы BGP внутри AS при выборе маршрутов не принимали конфликтующих решений, которые будут приводить к возникновению петель при пересылке пакетов.


3. Может ли маршрутизатор, находящийся на границе АС 100, и получивший информацию о пути к сети, находящейся в АС 200, распределить эту информацию среди своих внутренних соседей, т. е. BGP-маршрутизаторов АС 100, используя для этого протокол внутренней маршрутизации, такой как OSPF или RIP? Как именно происходит распространение этой BGP-маршрутной информации между внутреннми соседями АС?


есть IBGP(internal), ospf и rip нельзя, т.к. при отображении BGP на них не будет биекции


4. Протокол BGP предоставляет широкие возможности по управлению входящим (в АС) и исходящим (из АС) трафиком. Назовите основные возможности, иными словами инструменты, (как протокольные так и проприетарные Cisco) для управления трафиком. В чем суть каждой из этих возможностей (2-3 предложения или пример)?


Исходящий - weight(определение веса маршрутов), Local Preference(Указывает маршрутизаторам внутри автономной системы как выйти за её пределы) ,Балансировка трафика в BGP(распред по разн маршрутам)


Входящий - AS path prepend(удлиняет маршрут), community, MED(используется для информирования eBGP-соседей о том, какой путь в автономную систему более предпочтительный)
Атрибут community BGP-это числовое значение, которое может быть присвоено определенному префиксу и объявлено другим соседям. Когда сосед получает префикс, он изучает значение сообщества и принимает надлежащие меры, будь то фильтрация или изменение других атрибутов.
======================================================================


5. Описать процесс обработки BGP-сообщений UPDATE согласно RFC 4271 (A Border Gateway Protocol 4 (BGP-4)). Процесс выбора маршрутов (Decision Process), фаза 1: расчет предпочтений (Calculation of Degree of Preference), фаза 2: выбор маршрута (Route Selection), фаза 3: распространение маршрутов (Route Dissemination).


1. Сообщение UPDATE может быть получено только в состоянии Established. Получение такого сообщения в любом другом состоянии является ошибкой. При получении сообщения UPDATE проверяется корректность каждого поля.
2. Если не удается распознать
2.1 дополнительные непереходные атрибуты, они просто игнорируются. Если 2.2 дополнительные переходные атрибуты, устанавливается значение бита Partial=1 в поле флагов атрибута (третий по старшинству бит) и атрибут сохраняется для передачи другим узлам BGP.
3. Если дополнительный атрибут распознан и имеет корректное значение, тогда этот атрибут обрабатывается локально, сохраняется и обновляются (при необходимости) для возможной передачи другим узлам BGP.
4. Если сообщение UPDATE содержит непустое поле WITHDRAWN ROUTES (отзываемые маршруты) удаляются из таблицы Adj-RIB-In. Узлу BGP следует запустить процесс выбора маршрутов (Decision Process), поскольку анонсированные ранее маршруты больше не являются доступными.
5. Если сообщение UPDATE содержит доступный маршрут, таблицу Adj-RIB-In следует обновить, добавив этот маршрут, как указано здесь: если такое поле NLRI уже есть, то его нужно обновить иначе если Adj-RIB-In не содержит маршрута с идентичным значением NLRI, новый маршрут нужно включить в таблицу Adj-RIB-In.
6. После того, как узел BGP обновит базу Adj-RIB-In, ему нужно инициировать процесс выбора маршрутов (Decision Process). 
Фаза 1: Расчет предпочтений (Calculation of Degree of Preference)
Функция, используемая в фазе 1, блокирует базу  Adj-RIB-In прежде, чем начать работу с содержащимися в ней маршрутами и снимет блокировку по завершении работы со всеми новыми или недоступными маршрутами в этой базе.
При   получении   нового   маршрута   или   замене   доступного   маршрута   локальный   узел BGP определяет   уровень предпочтения, как описано ниже:
1. Если маршрут получен от внутреннего партнера в качестве уровня предпочтения принимается значение атрибута LOCAL_PREF или локальная система рассчитывает этот уровень на основе заданных конфигурацией параметров политики. Отметим, что последний вариант может приводить к возникновению постоянных маршрутных петель.
2. Если маршрут получен от внешнего партнера, локальный узел BGP рассчитывает уровень предпочтения на основе заданных конфигурацией параметров политики. Если полученное значение показывает, что маршрут является неподходящим, этот маршрут может не передаваться на следующий этап процесса выбора, в противном случае возвращенное значение должно использоваться как значение LOCAL_PREF в любом повторном анонсе IBGP.
3. Конкретные правила политики и методы расчета уровня предпочтения задаются локально
.Фаза 2: Выбор маршрута (Route Selection)
Фаза 2 выполняется после завершения фазы 1 и представляет собой отдельный процесс, который завершается после выполнения всех необходимых операций. В фазе 2 используются все маршруты из базы Adj-RIBs-In.
Активизация фазы 2 блокируется, пока не будет завершена работа фазы 3. Функция фазы 2 блокирует целиком базу Adj-RIBs-In перед началом работы и снимает блокировку по завершении расчета.
1. Если   атрибут NEXT_HOP маршрута BGP указывает   непреобразуемый  (Локальный узел не имеет маршрута для этого адреса в своей таблице) адрес или   этот   адрес   не   будет преобразовываться после установки маршрута, такой маршрут BGP должен исключаться из обработки в фазе 2.
2. Если атрибут AS_PATH маршрута BGP содержит петлю (AS loop), маршрут BGP следует исключить из рассмотрения в фазе 2.  


Для каждого набора адресатов, к которому существует доступный маршрут в таблице Adj-RIBs-In, локальный узел BGP идентифицирует маршрут, соответствующий одному из перечисленных условий:
1. маршрут имеет высший уровень предпочтения из всего набора путей к этому множеству адресатов;
2. маршрут является единственным для данного множества адресатов;
3. маршрут выбран в результате применения в фазе 2 правил «отбрасывания лишнего» (tie breaking) 
После этого локальному узлу следует установить маршрут в таблицу Loc-RIB, заменяя любой маршрут к тому же адресату. После включения нового маршрута BGP в таблицу маршрутизации следует принять меры по удалению из таблицы других маршрутов к тому же адресату. Принятие решения о замене имеющегося  в таблице маршрута,  полученного не от BGP определяется локальной политикой узла BGP.
Локальный узел должен определить адрес ближайшего маршрутизатора (immediate next-hop) из атрибута NEXT_HOP выбранного маршрута. При смене ближайшего маршрутизатора или стоимости IGP(Протокола внутренней маршрутизации) до NEXT_HOP выбор маршрута в фазе 2 должен быть проведен заново.
Маршруты, которые невозможно преобразовать, следует удалить из базы Loc-RIB и таблицы маршрутизации. Однако соответствующие непреобразуемые маршруты
следует сохранить в базе Adj-RIBs-In (впоследствии их преобразование может стать возможным).


Фаза 3: Распространение маршрутов (Route Dissemination)
Фаза 3 выполняется после завершения операций фазы 2 или по любому из перечисленных ниже событий:
1. изменение в Loc-RIB маршрутов к локальным адресатам;
2. изменение локально сгенерированных маршрутов, которые не были получены от BGP;
3. организация соединения с новым узлом BGP.
Функция фазы 3 представляет собой отдельный процесс, работа которого завершается после выполнения всех требуемых действий. Функция фазы 3 блокируется на время работы функции фазы 2. Все маршруты базы Loc-RIB обрабатываются для включения в Adj-RIBs-Out, согласно заданной конфигурацией политике. Эта политика может исключать маршруты, содержащиеся в Loc-RIB, из числа добавляемых в базу Adj-RIB-Out. 
Маршрут не следует устанавливать в Adj-Rib-Out, если для адресатов и NEXT_HOP этого маршрута таблице маршрутизации нет соответствующей записи. Если маршрут из базы Loc-RIB не включается в ту или иную базу Adj-RIB-Out, ранее анонсированный маршрут этой базы Adj-RIB-Out должен быть отозван с помощью сообщения
UPDATE.
После завершения процессов обновления Adj-RIBs-Out и таблицы маршрутизации локальный узел BGP запускает процесс передачи обновлений.




6. Атрибуты пути: определение, структура атрибутов, категории согласно значениям флагов (Attribute Flags). Использование атрибутов пути [эта часть вопроса будет разделена на варианты, например, 1-му варианту описать использование атрибута AS_PATH, 2-му - использование атрибута NEXT_HOP].


Атрибуты делятся на 4 категории:
1. Well-known mandatory – общеизвестные, обязательные.
2. Well-known discretionary – общеизвестные, необязательные.
3. Optional transitive – дополнительные, транзитивные (переходные).
4. Optional non-transitive – дополнительные, непереходные.


AS_PATH относится к общеизвестным обязательным атрибутам и служит для идентификации автономных систем, через которые передается информация в данном сообщении  UPDATE.


NEXT_HOP общеизвестный   обязательный атрибут, который определяет  IP-адрес   маршрутизатора, который следует использовать в качестве следующего интервала на пути к адресатам, указанным в сообщении UPDATE.


.




	

	

	

	

	

	

	

	

	

	

	



	

	

	

	

	

	

	

	

	Перевод RFC 4271
	

	

	

	

	

	♦    Если анонсируемый маршрут получен от внутреннего партнера или имеет локальное происхождение, узел BGP может использовать в качестве атрибута NEXT_HOP адрес интерфейса внутреннего (партнерского) маршрутизатора, через который анонсируемая сеть доступна для данного узла. В этом случае партнер X будет иметь общую подсеть с указанным адресом. Этот случай является вариантом NEXT_HOP из “третьих рук” (third party).
♦    В остальных случаях, если анонсируемый маршрут получен от внешнего партнера, узел BGP может использовать в атрибуте NEXT _HOP адрес IP любого смежного маршрутизатора (известный из принятого атрибута NEXT _HOP) который данный узел использует для локального определения маршрута, В таких случаях X имеет с указанным адресом общую подсеть. Этот случай является вариантом NEXT_HOP из “третьих рук”.
♦    В противном случае, если внешний партнер, для которого анонсируется маршрут, имеет общую подсеть с одним из интерфейсов анонсирующего узла, последний может использовать связанный с таким интерфесом адрес IP в качестве значения атрибута NEXT_HOP. Этот случай является вариантом NEXT_HOP из “первых рук” (first party).
♦    По умолчанию (если не выполняется ни одно из перечисленных выше условий), узлу BGP следует использовать в качестве атрибута NEXT_HOP IP-адрес интерфейса, который служит данному узлу для организации соединения BGP с партнером X.
3) При передаче сообщения внешнему партнеру X, находящемуся на расстоянии нескольких интервалов IP от данного узла (multihop EBGP):
♦    Узел может быть настроен на распространение атрибута NEXT_HOP. В таких случаях при анонсировании полученного от одного из партнеров маршрута узел должен указывать в качестве атрибута NEXT_HOP в анонсируемом маршруте значение NEXT_HOP, полученное в анонсе маршрута от партнера (т. е, узел не изменяет значение NEXT_HOP).
♦    По умолчанию узлу BGP следует использовать IP-адрес интерфейса, который узел указывает в атрибуте NEXT_HOP лоя организации соединение BGP с узлом X.
Обычно значение атрибута NEXT_HOP выбирается так, чтобы принимался кратчайший из возможных путей. Узел BGP должен обеспечивать возможность запрета анонсирования атрибутов NEXT_HOP, полученных “из третьих рук” для работы в сетях с несовершенными мостами.
Маршрут, порожденный узлом BGP, не следует анонсировать партнеру с использованием в качестве атрибута NEXT_HOP адреса этого партнера. Узлу BGP не следует устанавливать маршруты со своим адресом в качестве NEXT_HOP.
Атрибут NEXT_HOP используется узлами BGP для определения реального выходного интерфейса и адреса ближайшего маршрутизатора (immediate next-hop address), по которому следует пересылать транзитные пакеты для связанных с маршрутом адресатов.
Адрес ближайшего маршрутизатора (immediate next-hop address) определяется путем рекурсивного просмотра маршрутов для IP-адреса из атрибута NEXT_HOP, использования содержимого таблицы маршрутизации (Routing Table) и выбора одной записи, если существует множество равноценных путей. Запись таблицы маршрутизации, которая соответствует IP-адресу из атрибута NEXT_HOP, всегда будет задавать выходной интерфейс. Если запись таблицы маршрутизации указывает подключенную подсеть, но не задает адрес next-hop, тогда адрес из атрибута NEXT_HOP следует использовать в качестве адреса ближайшего маршрутизатора (immediate next-hop address). Если запись в таблице также содержит адрес next-hop, этот адрес следует использовать в качестве адреса ближайшего маршрутизатора для пересылки пакетов.